<style type="text/css">
    #networkViz {
        width: 400px;
        height: 400px;
        border: 1px solid lightgray;
    }
</style>

<div class="alert alert-info alert-dismissible" role="alert">
    <button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button>
    Now we're ready to configure the property graph data model. Step 1) Declare Label names for each Node. Step 2) Select which column defines the primary key for each Node. Optionally, rename or skip any columns. Step 3) Create relationships with the "Create New" button. When your data model is defined, click the Next button to begin import to Neo4j.
</div>

<div class="row">
    <div class="col-xs-6">
        <h3>Relationships</h3>
        <table class="table">
            <tbody id="relTableBody">
                <tr>
                    <th>From</th>
                    <th>Name</th>
                    <th>To</th>
                </tr>

            </tbody>
            <tfoot>
            <tr>
                <td></td>
                <td></td>
                <td><button class="btn btn-primary btn-sm" id="modalToggleButton">Create New</button></td>
            </tr>
            </tfoot>
        </table>
    </div>
    <div class="col-xs-6" id="networkViz">
        <!-- <img src="http://placehold.it/350x400"> -->
    </div>
</div>
<div>
<!--<div class="row"> -->

    <div>

        <!-- Nav tabs -->
        <div class="row" style="padding:20px;">
            <div class="col-sm-10">
                <ul class="nav nav-tabs" role="tablist">
                    <li role="presentation" class="active"><a href="#nodesTab" role="tab" data-toggle="tab">Nodes</a></li>
                    <li role="presentation"><a href="#relsTab" role="tab" data-toggle="tab" id="relationshipTabNav">Relationships</a></li>
                </ul>
            </div>
            <div class="col-sm-2">
                <div class="btn-toolbar" role="toolbar" aria-label="fileActionButtons">
                    <!-- <div class="btn-group btn-group-sm" role="group" aria-label="newActionButtons">
                        <button type="button" class="btn btn-default">New Node</button>
                        <button type="button" class="btn btn-default">New Relationship</button>
                    </div> -->
                    <div class="btn-group btn-group-sm" role="group">
                        <button type="submit" id="submit" class="btn btn-success">Import >></button>
                    </div>
                </div>
            </div>
        </div>

        <div class="tab-content">
            <div role="tabpanel active" class="tab-pane active" id="nodesTab">
                <div class="row">
                    <div class="col-sm-10">
                        <ul class="nav nav-tabs" role="tablist">
                            {{# each config.nodes}}
                                <li role="presentation" class="nodeTabListItem"><a href="#{{guid}}" aria-controls="{{guid}}" role="tab" data-toggle="tab">{{filename}}</a></li>
                            {{/each}}

                        </ul>
                    </div>
                    <div class="col-sm-2">
                        <button class="btn btn-default btn-xs" id="newNodeButton">New Node</button>
                    </div>
                </div>


                <div class="tab-content">
                    {{# each config.nodes}}
                        <div role="tabpanel" class="tab-pane node-tab-pane" id="{{guid}}">
                            <div class="{{guid}}-nodePaneDiv">
                                <div id="{{guid}}-datamodelPane">
                                    <div class="row">
                                        <div class="col-sm-6">
                                            <div class="form-group">
                                                <label for="{{guid}}-labelInput" class="col-sm-2 control-label">Label</label>
                                                <div class="col-sm-10" style="padding:20px;">
                                                    <input type="text" class="form-control labelInput" name="{{guid}}-labelInput" data-id="{{guid}}" id="{{guid}}-labelInput" placeholder="Node" required>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <table class="table">
                                        <tbody>
                                        <tr>
                                            <th>Column</th>
                                            <th>Rename</th>
                                            <th>Skip <button type="button" class="btn btn-default btn-xs" id="toggleSkipButton">Toggle All</button></th>
                                            <th>PK</th>
                                            <th>Datatype</th>
                                            <th>Create Index</th>
                                            <th>FK</th>
                                        </tr>
                                        {{# each properties}}
                                            <tr>
                                                <td>{{headerKey}}</td>
                                                <td><label><input class="renameLabel" data-guid="{{../guid}}" data-field="{{headerKey}}" type="text" name="{{../guid}}-{{headerKey}}-rename"></label></td>
                                                <td><label><input class="skipCheckBox"data-guid="{{../guid}}" data-field="{{headerKey}}" type="checkbox" name="{{../guid}}-{{headerKey}}-skip"></label></td>
                                                <td><label><input type="checkbox" data-guid="{{../guid}}" data-field="{{headerKey}}" class="pkcheckbox" name="{{../guid}}-{{headerKey}}-pk"></label></td>
                                                <td><label><select><option value="---">---</option></select></label></td>
                                                <td><label><input class="indexCheckbox" type="checkbox" data-guid="{{../guid}}" data-field="{{headerKey}}" name="{{../guid}}-{{headerKey}}-index"></label></td>
                                                <td><button type="button" class="btn btn-sm">---</button></td>
                                            </tr>
                                        {{/each}}

                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    {{/each}}
                </div>
            </div>

            <div role="tabpanel active" class="tab-pane" id="relsTab">
                <div class="row">
                    <div class="col-sm-10">
                        <ul class="nav nav-tabs col-sm-8" role="tablist">

                            {{# each config.relationships}}
                                <li role="presentation" class="relTabListItem"><a href="#{{guid}}" aria-controls="{{guid}}" role="tab" data-toggle="tab">{{filename}}</a></li>
                            {{/each}}
                        </ul>
                    </div>
                    <div class="col-sm-2">
                        <button class="btn btn-default btn-xs" id="newRelationshipButton">New Relationship</button>
                    </div>
                </div>

                <div class="tab-content">
                    {{# each config.relationships}}
                        <div role="tabpanel" class="tab-pane rel-tab-pane" id="{{guid}}">
                                <form class="form-horizontal">
                                    <div class="row col-sm-12">
                                <div class="form-group">
                                    <!-- FROM -->
                                    <label for="{{guid}}-fromLabelSelect" class="col-sm-4 control-label">From - Label</label>
                                    <div class="col-sm-8">
                                        <select class="form-control labelSelect fromLabelSelect" id="{{guid}}-fromLabelSelect" data-guid="{{guid}}"><option value="---">Label</option></select>
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label for="{{guid}}-fromNeoKeySelect" class="col-sm-4 control-label">From - neoKey</label>
                                    <div class="col-sm-8">
                                        <select class="form-control" id="{{guid}}-fromNeoKeySelect" data-guid="{{guid}}" disabled><option value="---">Label</option></select>
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label for="{{guid}}-fromHeaderKeySelect" class="col-sm-4 control-label">From - headerKey</label>
                                    <div class="col-sm-8">
                                        <select class="form-control" id="{{guid}}-fromHeaderKeySelect" data-guid="{{guid}}" disabled><option value="---"></option></select>
                                    </div>
                                </div>

                                <!-- TO -->
                                <div class="form-group">
                                    <label for="{{guid}}-toLabelSelect" class="col-sm-4 control-label">To - label</label>
                                    <div class="col-sm-8">
                                        <select class="form-control labelSelect toLabelSelect" id="{{guid}}-toLabelSelect" data-guid="{{guid}}"><option value="---">Label</option></select>
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label for="{{guid}}-toNeoKeySelect" class="col-sm-4 control-label">To - neoKey</label>
                                    <div class="col-sm-8">
                                        <select class="form-control" id="{{guid}}-toNeoKeySelect" data-guid="{{guid}}" disabled><option value="---">Label</option></select>
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label for="{{guid}}-toHeaderKeySelect" class="col-sm-4 control-label">To - headerKey</label>
                                    <div class="col-sm-8">
                                        <select class="form-control" id="{{guid}}-toHeaderKeySelect" data-guid="{{guid}}" disabled><option value="---">Label</option></select>
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label for="{{guid}}-nameInput" class="col-sm-2 control-label">Relationship name</label>
                                    <div class="col-sm-10">
                                        <input type="text" class="form-control" id="{{guid}}-nameInput" data-guid="{{guid}}" placeholder="SERVES_ON">
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label for="{{guid}}-filenameInput" class="col-sm-2 control-label">Filename</label>
                                    <div class="col-sm-10">
                                        <select class="form-control" id="{{guid}}-filenameInput" data-guid="{{guid}}">
                                            {{# each ../files }}
                                                <option value="{{this}}">{{this}}</option>
                                            {{/each}}
                                        </select>
                                    </div>
                                </div>

                                <div class="form-group">
                                    <div class="col-sm-offset-2 col-sm-10">
                                        <button type="submit" class="btn btn-default config-rel-button" data-guid="{{guid}}">Add Relationship</button>
                                    </div>
                                </div>
                                    </div>
                            </form>
                        </div>
                    {{/each}}
                </div>
            </div>

        </div>

    </div>
    </div>

<!-- Modal -->
<div class="modal fade" id="newRelModal" tabindex="-1" role="dialog"
     aria-labelledby="myModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <!-- Modal Header -->
            <div class="modal-header">
                <button type="button" class="close"
                        data-dismiss="modal">
                    <span aria-hidden="true">&times;</span>
                    <span class="sr-only">Close</span>
                </button>
                <h4 class="modal-title" id="myModalLabel">
                    Create Relationship
                </h4>
            </div>

            <!-- Modal Body -->
            <div class="modal-body">



                <form class="form-horizontal">
                    <div class="form-group">
                        <!-- FROM -->
                        <label for="fromLabelSelect" class="col-sm-4 control-label">From - Label</label>
                        <div class="col-sm-8">
                            <select class="form-control" id="fromLabelSelect"><option value="---">Label</option></select>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="fromNeoKeySelect" class="col-sm-4 control-label">From - neoKey</label>
                        <div class="col-sm-8">
                            <select class="form-control" id="fromNeoKeySelect" disabled><option value="---">Label</option></select>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="fromHeaderKeySelect" class="col-sm-4 control-label">From - headerKey</label>
                        <div class="col-sm-8">
                            <select class="form-control" id="fromHeaderKeySelect" disabled><option value="---">Label</option></select>
                        </div>
                    </div>

                    <!-- TO -->
                    <div class="form-group">
                        <label for="toLabelSelect" class="col-sm-4 control-label">To - label</label>
                        <div class="col-sm-8">
                            <select class="form-control" id="toLabelSelect"><option value="---">Label</option></select>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="toNeoKeySelect" class="col-sm-4 control-label">To - neoKey</label>
                        <div class="col-sm-8">
                            <select class="form-control" id="toNeoKeySelect" disabled><option value="---">Label</option></select>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="toHeaderKeySelect" class="col-sm-4 control-label">To - headerKey</label>
                        <div class="col-sm-8">
                            <select class="form-control" id="toHeaderKeySelect" disabled><option value="---">Label</option></select>
                        </div>
                    </div>


                    <div class="form-group">
                        <label for="nameInput" class="col-sm-2 control-label">Relationship name</label>
                        <div class="col-sm-10">
                            <input type="text" class="form-control" id="nameInput" placeholder="SERVES_ON">
                        </div>
                    </div>


                    <div class="form-group">
                        <label for="filenameInput" class="col-sm-2 control-label">Filename</label>
                        <div class="col-sm-10">
                            <select class="form-control" id="filenameInput" placeholder="legislators.csv">
                            {{# each files}}
                                <option value="{{this}}">{{this}}</option>
                            {{/each}}


                            </select>

                        </div>
                    </div>

                </form>

            <!-- Modal Footer -->
            <div class="modal-footer">
                <button type="button" class="btn btn-default"
                        data-dismiss="modal">
                    Close
                </button>
                <button type="button" id="createRelButton" class="btn btn-primary" data-dismiss="modal">
                    Create
                </button>
            </div>
        </div>
    </div>
</div>
    </div>


<script>
    var configData = JSON.parse('{{{stringify this.config}}}');
    console.log(configData);
    var network; // network viz

    // iterate through all relationships and hide the filename-node-pane element for that file
    // toggle the node button off
    // toggle the relationship button on

    // TODO: move into document.ready
//    _.forEach(configData.relationships, function(relObject) {
//       var filename = relObject.filename.split(".").join("");
//        console.log(filename);
//        $('#'+filename +'-datamodel-pane').remove();
//        $('#'+filename + '-node-button').prop('disabled', true).removeClass("active");
//        $('#'+filename + '-rel-button').prop('disabled', false).addClass("active");
//        //$('#'+filename + '-nodePaneDiv').empty();
//        $('#'+filename + '-rel-message').show();
//
//    });

    $(function() {
        // set first tab as active
        //$('.nav-tabs li').first().show();
        //$('.nav-tabs li').first().addClass("active");
        //$('.tab-pane').first().addClass("active");

        $('.nodeTabListItem').first().addClass("active");
        $('.relTabListItem').first().addClass("active");
        $('.node-tab-pane').first().addClass("active");
        $('.rel-tab-pane').first().addClass("active");

//        $("ul.nav-tabs a").click(function (e) {
//            e.preventDefault();
//            $(this).tab('show');
//        });

        function drawNetworkViz() {
            var nodesArr = [];
            $.each(configData.nodes, function(i, el){
                console.log(el);
                var name = '';
                if (el.labels) {
                    name = el.labels[0];
                } else {
                    name = el.filename || name;
                }
                nodesArr.push({id: i, label: name});
            });

            // FIXME: duplicated code
            var edges = [];
            $.each(configData.relationships, function(i, el) {
                if (el.to && el.from) {
                    console.log(el);
                    var from = _.findIndex(configData.nodes, {labels: [el.from.label]});
                    var to = _.findIndex(configData.nodes, {labels: [el.to.label]});

                    var edge = {from: from, arrows: "to", to: to, label: el.name};
                    edges.push(edge);
                }

            });

            var container = document.getElementById('networkViz');
            var data = {
                nodes: new vis.DataSet(nodesArr),
                config: {},
                edges: new vis.DataSet(edges)
            };
            var options = {};

            network = new vis.Network(container, data, options);

            console.log("network drawn");
        }

        function updateNetworkViz() {
            var nodesArr = [];
            $.each(configData.nodes, function(i, el){
                console.log(el);
                var name = '';
                if (el.labels) {
                    name = el.labels[0];
                } else {
                    name = el.filename || name;
                }
                nodesArr.push({id: i, label: name});
            });

            var edges = [];
            $.each(configData.relationships, function(i, el) {

                if (el.from && el.to) {

                    console.log(el);
                    var from = _.findIndex(configData.nodes, {labels: [el.from.label]});
                    var to = _.findIndex(configData.nodes, {labels: [el.to.label]});

                    var edge = {from: from, arrows: "to", to: to, label: el.name};
                    edges.push(edge);
                }

            });

            //console.log(edges);

            var data = {
                nodes: new vis.DataSet(nodesArr),
                config: {},
                edges: new vis.DataSet(edges)
            };

            network.setData(data);
        }

        function handleUpdateLabel(e) {
            // figure out which file the update belongs to
            // update the config data
            // call drawNetworkViz()
            console.log(e);
            var guid = $(e.target).data("id");
            var node = _.find(configData.nodes, {guid: guid});
            node['labels'] = [$(e.target).val()];
            console.log(configData);
            drawNetworkViz();
            populateLabelSelects();
        }

        function drawRelationshipTable(){
            var relTableBody = $('#relTableBody').children().not(':first').remove();
            _.forEach(configData.relationships, function(rel, i) {
                if (rel.from && rel.to) {
                    var row = "<tr>";
                    row += "<td>" + rel.from.label + ":" + rel.from.neoKey + "</td>";
                    row += "<td>" + rel.name + "</td>";
                    row += "<td>" + rel.to.label + ":" + rel.to.neoKey + "</td>";
                    $('#relTableBody').append(row);
                }

            })
        }


        // UI handlers
        $('.labelInput').change(function(e){handleUpdateLabel(e)});

        $('#createRelButton').click(function() {

            // TODO: This logic should be moved into relationship pane
            var relName = $('#nameInput').val();
            var filename = $('#filenameInput').val();

            var fromLabel = $('#fromLabelSelect').val();
            var fromKey = $('#fromNeoKeySelect').val();
            var fromFileKey = $('#fromHeaderKeySelect').val();

            //var toArr = to.split(":");

            var toLabel = $('#toLabelSelect').val();
            var toKey = $('#toNeoKeySelect').val();
            var toFileKey = $('#toHeaderKeySelect').val();


            var createdNewRelationship = false;
            // FIXME: need to find on a guid here not a filename
            var newRel = _.find(configData.relationships, {filename: filename});

            if (!newRel) {
                newRel = {};
                createdNewRelationship = true;
            }

            newRel['name'] = relName;
            newRel['filename'] = filename;
            var fromObj = {};
            fromObj['label'] = fromLabel;
            fromObj['neoKey'] = fromKey;
            fromObj['fileKey'] = fromFileKey;
            var toObj = {};
            toObj['label'] = toLabel;
            toObj['neoKey'] = toKey;
            toObj['fileKey'] = toFileKey;

            newRel['from'] = fromObj;
            newRel['to'] = toObj;


            if (createdNewRelationship) {
                configData.relationships.push(newRel);
            }

            console.log(configData);

            drawRelationshipTable();
            updateNetworkViz();

        });

        $('.renameLabel').change(function(e){

            var guid = $(e.target).data("guid");
            var field = $(e.target).data("field");

            var node = _.find(configData.nodes, {guid: guid});
            var property = _.find(node.properties, {headerKey: field});
            property['neoKey'] = $(e.target).val();

            console.log(configData);
        });

        // TODO: include checkbox handler

        $('.skipCheckBox').change(function(e){
            var guid = $(e.target).data("guid");
            var field = $(e.target).data("field");

            var node = _.find(configData.nodes, {guid: guid});
            var property = _.find(node.properties, {headerKey: field});

            if ($(e.target).is(':checked')) {
                property['skip'] = true;
            } else {
                property['skip'] = false;
            }

            console.log(configData);

        });
        // TODO: PK checkbox handler
        $('.pkcheckbox').change(function(e){
            var guid = $(e.target).data("guid");
            console.log(guid);
            var field = $(e.target).data("field");

            var node = _.find(configData.nodes, {guid: guid});
            var property = _.find(node.properties, {headerKey: field});

            if ($(e.target).is(':checked')) {
                property['primaryKey'] = true;
            } else {
                property['primaryKey'] = false;
            }

            // TODO: toggle index for this property automatically
            console.log(configData);

        });


        // TODO: Datatype dropdown handler
        // TODO: Create index handler
        $('.indexcheckbox').change(function(e){
            var guid = $(e.target).data("guid");
            var field = $(e.target).data("field");

            var node = _.find(configData.nodes, {guid: guid});
            var property = _.find(node.properties, {headerKey: field});

            if ($(e.target).is(':checked')) {
                property['index'] = true;
            } else {
                property['index'] = false;
            }

            console.log(configData);

        });

        // TODO: FK handler

        $('#submit').click(function(e){
            // TODO: validate configuration object at this point
            e.preventDefault();

            $.ajax({
                type: 'POST',
                data: JSON.stringify(configData),
                contentType: 'application/json',
                url: '/datamodel',
                success: function(data) {
                    window.location.href = '/import';
                }
            })
        });

        // TODO: get all labels
        function getAllLabels() {

            var labels = [];
            _.forEach(configData.nodes, function(node) {
                _.forEach(node.labels, function(label) {
                    if (!_.includes(labels, label)) {
                        labels.push(label);
                    }

                })
            });

            console.log(labels);
            return labels;
        }

        // TODO: get all neoKeys (for a given label)
        function neoKeysForLabel(label) {
            var keys = [];
            console.log(label);

            var filteredNodes = _.filter(configData.nodes, function(node) {
                return _.includes(node.labels, label);
            });

            console.log(filteredNodes);

            _.forEach(filteredNodes, function(node){
                _.forEach(node.properties, function(property){
                    keys.push(property.neoKey);
                });

            });

            return keys;
        }

        // TODO: get all neoKeys + headerKeys (for a given label)
        function allKeysForLabel(label) {
            var keys = [];

            var filteredNodes = _.filter(configData.nodes, function(node) {
                return _.includes(node.labels, label);
            });

            console.log(filteredNodes);

            _.forEach(filteredNodes, function(node){
                _.forEach(node.properties, function(property) {
                    keys.push(property.neoKey);
                    if (!_.includes(keys, property.headerKey)) {
                        keys.push(property.headerKey);
                    }
                })

            });

            console.log(keys);
            return keys;
        }

        // TODO: populate from / to dropdowns
        function populateLabelSelects() {
            var labels = getAllLabels();
            console.log(labels);

            $('.labelSelect').empty();
            $.each(labels, function(i, label){
                $('.labelSelect')
                        .append($("<option></option>")
                        .attr("value", label)
                        .text(label));
            });

            updateAllLabelSelects();
            //updateFromLabelSelects();
            //updateToLabelSelects();

        }

        // TODO: input handlers



        // fromLabelSelect handler
        //   - on select make fromNeoKeySelect and fromHeaderKeySelect enabled
        //   - populate fromNeoKeySelect and fromHeaderKeySelect with valid options

        function updateFromLabelSelects(el) {

            var neoKeys = neoKeysForLabel(el.val());
            var allKeys = allKeysForLabel(el.val());
            var guid = el.data("guid");
            var selectInputs = $('#' + guid + '-fromNeoKeySelect, #' + guid + '-fromHeaderKeySelect');

            selectInputs.prop("disabled", false).empty();

            $.each(neoKeys, function(i, key) {
                selectInputs.append($("<option></option>")
                        .attr("value", key)
                        .text(key));
            });


            // FIXME: this doesn't do anything now - should these fields really be actual fields for the selected file??

            $.each(allKeys, function (i, key) {
                $('#fromHeaderKeySelect').append($("<option></option>")
                        .attr("value", key)
                        .text(key));
            })
        }

        function updateToLabelSelects(el) {
            var neoKeys = neoKeysForLabel(el.val());
            var allKeys = allKeysForLabel(el.val());
            var guid = el.data("guid");
            var selectInputs = $('#' + guid + '-toNeoKeySelect, #' + guid + '-toHeaderKeySelect');

            selectInputs.prop("disabled", false).empty();

            $.each(neoKeys, function(i, key) {
                selectInputs.append($("<option></option>")
                        .attr("value", key)
                        .text(key));

            });


            // FIXME: this doesn't do anything now - should these fields really be actual fields for the selected file??

            $.each(allKeys, function (i, key) {
                $('#toHeaderKeySelect').append($("<option></option>")
                        .attr("value", key)
                        .text(key));
            })
        }


        function updateAllLabelSelects() {
            // call updateFromLabelSelects with a selector for all fromLabelSelects
            // call updateToLabelSelects with a selector for all toLabelSelects
            updateFromLabelSelects($('.labelSelect'));
            updateToLabelSelects($('.labelSelect'));


        }

        $('.fromLabelSelect').change(function(e){

            updateFromLabelSelects($(e.target));

        });

        $('.toLabelSelect').change(function(e){
            updateToLabelSelects($(e.target));
        });

//        $('#fromNeoKeySelect').change(function(e) {
//            var allKeys = allKeysForLabel($('#fromLabelSelect').val());
//            $('#fromHeaderKeySelect').prop("disabled", false).empty();
//
//            $.each(allKeys, function (i, key) {
//                $('#fromHeaderKeySelect').append($("<option></option>")
//                        .attr("value", key)
//                        .text(key));
//            })
//        });

        // toLabelSelect handler
        //   - similar functionality ^^



//        $('#toNeoKeySelect').change(function(e) {
//            var allKeys = allKeysForLabel($('#toLabelSelect').val());
//            $('#toHeaderKeySelect').prop("disabled", false).empty();
//
//            $.each(allKeys, function (i, key) {
//                $('#toHeaderKeySelect').append($("<option></option>")
//                        .attr("value", key)
//                        .text(key));
//            })
//        });

        $('#modalToggleButton, #relationshipTabNav').click(function(e) {
            console.log("dont' show the modal");

            // data-toggle="modal" data-target="#newRelModal"

            var inputs = $('.labelInput');

            for (var i=0;i<inputs.length;i++) {
                if ($(inputs[i]).val() === '') {
                    alert("Please select labels for all Nodes before adding relationships.");
                    return false;
                }
            }

            if ($(this).is('#modalToggleButton')) {
                $('#newRelModal').modal('toggle');
            }


        });


        $('#toggleSkipButton').click(function(e){
            $("input[type='checkbox']:visible.skipCheckBox").prop( "checked", function( i, val ) {
                return !val;
            });
        });

        $('.config-rel-button').click(function(e){
            var target = $(this);
            var guid = $(this).data("guid");
            e.preventDefault();

            var relName = $('#'+ guid + '-nameInput').val();
            var fileName= $('#' + guid + '-filenameInput').val();

            var fromLabel = $('#' + guid +'-fromLabelSelect').val();
            var fromKey = $('#' + guid + '-fromNeoKeySelect').val();
            var fromFileKey = $('#' + guid + '-fromHeaderKeySelect').val();

            var toLabel = $('#' + guid + '-toLabelSelect').val();
            var toKey = $('#' + guid + '-toNeoKeySelect').val();
            var toFileKey = $('#' + guid + '-toHeaderKeySelect').val();

            var createdNewRelationship = false;

            var newRel = _.find(configData.relationships, {guid: guid});

            if (!newRel) {
                newRel = {};
                createdNewRelationship = true;
            }

            newRel['name'] = relName;
            newRel['filename'] = fileName;

            var fromObj = {};
            fromObj['label'] = fromLabel;
            fromObj['neoKey'] = fromKey;
            fromObj['fileKey'] = fromFileKey;

            var toObj = {};
            toObj['label'] = toLabel;
            toObj['neoKey'] = toKey;
            toObj['fileKey'] = toFileKey;

            newRel['from'] = fromObj;
            newRel['to'] = toObj;

            if (createdNewRelationship) {
                configData.relationships.push(newRel);
            }

            console.log(configData);

            drawRelationshipTable();
            updateNetworkViz();



        });


        populateLabelSelects();
        drawNetworkViz();
        drawRelationshipTable();  // FIXME: only skeleton of relationship object at load. dont' add row if missing properties
    });
</script>